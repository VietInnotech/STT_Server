# Android App & Server Integration Guide

## 1. Current Upload Implementation

### Upload Endpoints
The Android app currently uses two distinct sets of endpoints: one for **MAIE Processing** (intelligence) and one for **File Storage** (backend persistence).

**1. MAIE Processing (Intelligence)**
*   **Audio Processing:** `POST /v1/process`
*   **Text Processing:** `POST /v1/process_text`
*   **Template Fetching:** `GET /v1/templates`
*   **Status Polling:** `GET /v1/status/{task_id}`

**2. File Storage (Persistence)**
*   **Audio Upload:** `POST /api/files/audio`
*   **Text Upload:** `POST /api/files/text`
*   **Note:** The specific endpoint `/api/files/text-pair-android` is **NOT** currently used in the codebase. The app uses `/api/files/text` for uploading transcripts.

### Payload Structures

#### A. Storage Upload (`/api/files/text`)
Used when saving a transcript to the server without triggering new processing.
*   **Content-Type:** `multipart/form-data`
*   **Fields:**
    *   `file`: The text file content (`.txt`).
    *   `deviceId`: The unique device fingerprint.
*   **Authentication:** `Authorization: Bearer <token>`

#### B. MAIE Audio Processing (`/v1/process`)
Used to upload audio for transcription and summarization.
*   **Content-Type:** `multipart/form-data`
*   **Fields:**
    *   `file`: The audio file (`.wav`).
    *   `features`: A string "summary" (to request summarization).
    *   `template_id`: The ID of the selected template (e.g., `meeting_notes_v2`).
*   **Authentication:** `X-API-Key` header (currently hardcoded dev key).

### Error Handling
*   **Network Errors:** The app catches `Exception` during network calls.
*   **HTTP Errors:** Checks `responseCode`. If not 200/201/202, it reads `errorStream` and throws an exception.
*   **User Feedback:** Displays `Toast` messages for errors (e.g., "Lỗi: ...") and dismisses progress dialogs.
*   **Retry Logic:** There is no automatic retry logic for failed uploads, but there is a polling retry loop (360 attempts * 10s) for checking task status.

---

## 2. Processing & Results Generation

### MAIE Integration Method
The integration is **Direct from Android to MAIE** for processing.
1.  **Fetch Templates:** App fetches available templates from `/v1/templates`.
2.  **User Selection:** User selects a template via a dialog.
3.  **Upload & Trigger:** App uploads audio/text + `template_id` to `/v1/process` (or `_text`).
4.  **Poll:** App receives a `task_id` and polls `/v1/status/{task_id}` every 5-10 seconds.
5.  **Result:** When status is `COMPLETE`, the full JSON result is downloaded.

### MAIE Result Structure
The app expects the following JSON structure from the MAIE status endpoint:

```json
{
  "status": "COMPLETE",
  "result": {
    "results": {
      "summary": {
        "title": "Meeting Title",
        "content": "..."
      },
      "transcript": "..."
    }
  }
}
```

### Template Application
*   **Mechanism:** User-selected before processing.
*   **Source:** Fetched dynamically from `GET /v1/templates`.
*   **UI:** A radio button dialog showing Template Name and Description.
*   **Persistence:** The app saves the last selected `template_id` in `SecurePreferences` to pre-select it next time.

### Result Caching
*   **Local Cache:** Results are cached in a local file `json_cache.txt` in the app's internal storage.
*   **Structure:** `filename | json_length | json_content`.
*   **Purpose:** Allows viewing previous results without re-fetching (though UI implementation of history viewing needs verification).

---

## 3. Audio File Handling

### Audio Format
*   **Format:** WAV (Raw PCM)
*   **Sample Rate:** 16,000 Hz (16 kHz)
*   **Channels:** Mono (1 channel)
*   **Bit Depth:** 16-bit PCM
*   **Source:** `AudioSource.MIC`

### Audio → Server Path
*   **Storage:** The app has a dedicated function `uploadAudioToServer` that sends to `/api/files/audio`.
*   **Processing:** For MAIE, audio is sent to `/v1/process`.
*   **Relationship:** These appear to be separate actions in the current UI (one for "Process", one for "Upload to Server").

### Offline Capability
*   **Recording:** Audio is always saved locally to the device's `filesDir` first as `.wav` chunks.
*   **Upload:** No automatic offline queue. If internet is unavailable, the upload fails with a Toast. The user must manually retry later.
*   **Storage:** Files persist locally until manually deleted or cleared.

---

## 4. Metadata & Tags

### Tags
*   **Current State:** The app does **NOT** currently send or process specific "tags" (like `["meeting", "Q4"]`).
*   **Metadata:** The primary metadata sent is `template_id` and `deviceId`.

### Title Generation
*   **Source:** The title is generated by the **Server/MAIE** as part of the summary result.
*   **Extraction:** The app parses `root.results.summary.title` from the JSON response.
*   **User Edit:** There is no explicit "Edit Title" feature before upload. The title comes back *after* processing.

---

## 5. User Experience & Workflow

### Workflow
1.  **Record:** User records audio. Real-time transcription (if enabled/supported) shows on screen.
2.  **Stop:** User stops recording.
3.  **Action:** User clicks a button (e.g., "Process" or "Upload").
4.  **Template:** Dialog appears to select a Template (e.g., "Meeting Notes").
5.  **Process:**
    *   Progress dialog shows "Uploading..." then "Processing...".
    *   App polls server.
6.  **Result:**
    *   Dialog closes.
    *   Result is displayed in the main view (Title + Summary/Transcript).
    *   Options to Share/Export (PDF, DOCX, TXT).

### Syncing
*   **Upload History:** There is no "Sync" feature to pull history from the server.
*   **Web UI:** The app is not currently integrated to show a "Web Dashboard" view. It acts as a capture and process client.

---

## 6. Device & Session Management

### Device ID Tracking
*   **Generation:** `android-` + Hex Hash of (`ANDROID_ID` + `Manufacturer` + `Model`).
*   **Persistence:** Stored in `SecurePreferences` (EncryptedSharedPreferences). Persists across app restarts, but **NOT** across app uninstalls (Android behavior for `ANDROID_ID` can vary, but the stored pref is cleared on uninstall).
*   **Usage:** Sent as a field `deviceId` in `/api/files/` uploads.

### Authentication
*   **Method:** JWT (JSON Web Token).
*   **Login:** `/auth/login` returns a token.
*   **Storage:** Encrypted in `SecurePreferences`.
*   **Interceptor:** `AuthInterceptor` adds `Authorization: Bearer <token>` to every request to the main API.
*   **Refresh:** `ApiService` has a `refreshToken` endpoint, but automatic refresh logic in the Interceptor is currently just clearing the token on 401 (Logout).

---

