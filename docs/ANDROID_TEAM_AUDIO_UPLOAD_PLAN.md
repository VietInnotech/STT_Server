# Android Team â€“ Audio Upload and Live Transcript Integration Plan

This document describes how the Android app should integrate with the UNV AI Report Server for audio processing and live transcript submission. It is written for Android developers and does not contain code examples.

---

## Overview

The Android app records audio and optionally generates a live (realtime) transcript during recording. After recording completes, the app:

1. Optionally submits the live transcript to the server (if available).
2. Submits the audio file to the server for MAIE processing.

The server handles all MAIE communication; Android never contacts MAIE directly. The server will persist the audio, link it to the live transcript, and store MAIE results (transcript and summary).

---

## Important Policy: No Summary from Android

**Android must NOT send a summary.**

- The summary is generated by MAIE on the server side.
- If Android sends a summary field, the server will reject the request with a 400 error.
- Android should only send the live transcript (realtime field) when available.

---

## Recommended Upload Flow

### Step 1: Submit Live Transcript (if available)

If the Android app generated a live transcript during recording, submit it before uploading the audio.

**Endpoint:** POST /api/files/text-pair-android

**Headers:**

- Authorization: Bearer (user token)
- Content-Type: application/json

**Request Body (JSON):**

- realtime (string, required): The full live transcript text captured during recording.
- clientUploadId (string, optional but recommended): A unique identifier generated by Android (such as a UUID) to enable idempotent retries. If the same clientUploadId is submitted again, the server may return the existing record instead of creating a duplicate.

**Response (success, 201):**

- id: The server-assigned identifier for the TextFilePair record.
- realtimeId: The identifier for the realtime TextFile.
- createdAt: Timestamp of creation.

**Error Responses:**

- 400: Request validation failed (for example, summary field was present, or realtime was missing).
- 401: Authentication required.
- 429: Rate limit exceeded; retry after the time specified in the Retry-After header.
- 500: Server error.

**What to do with the response:**

- Save the returned id (the TextFilePair ID) to include in the audio upload request in Step 2.
- If the request fails, retry with the same clientUploadId.

---

### Step 2: Submit Audio for Processing

After optionally submitting the live transcript, submit the audio file.

**Endpoint:** POST /api/process

**Headers:**

- Authorization: Bearer (user token)
- Content-Type: multipart/form-data

**Form Fields:**

- audio (file, required): The audio file. Supported formats include m4a, wav, mp3, ogg, webm, and others accepted by MAIE.
- sourceTextFilePairId (string, optional): The TextFilePair ID returned from Step 1. Include this to link the audio and MAIE results to the live transcript.
- clientUploadId (string, optional but recommended): A unique identifier for idempotent retries.

**Response (success, 200 or 202):**

- id: The ProcessingResult identifier.
- status: Processing status (pending, processing, completed, or error).
- sourceAudioId: The server-assigned identifier for the persisted audio file (once implemented).
- sourceTextFilePairId: The linked TextFilePair ID, if provided.

**Error Responses:**

- 400: Invalid audio format or file too large.
- 401: Authentication required.
- 413: Audio file exceeds the maximum allowed size (server-configured limit, typically 50 MB).
- 429: Rate limit exceeded.
- 500: Server or MAIE processing error.

**What to do with the response:**

- Save the ProcessingResult id to poll for status or listen via WebSocket.
- If status is pending or processing, poll GET /api/process/(id) or subscribe to socket events.

---

## Linking Summary

After both steps complete, the server will have:

- An AudioFile record with the persisted audio.
- A TextFilePair record with the live transcript (realtime).
- A ProcessingResult record with MAIE transcript and summary, linked to both the AudioFile and TextFilePair.

This enables the server UI to display:

- Audio playback.
- Side-by-side comparison of live transcript and MAIE transcript.
- The MAIE-generated summary.

---

## File Size Limits

- Audio files: Maximum size is configurable by the server administrator (default 50 MB).
- Live transcript text: No strict limit, but extremely large text may be rejected.

If the file exceeds the limit, the server returns 413 (Payload Too Large).

---

## Retry and Idempotency Recommendations

1. Generate a unique clientUploadId (such as a UUID) for each recording session.
2. Use the same clientUploadId for both the live transcript and audio upload requests for that session.
3. If a request times out or fails with a 5xx error, retry with the same clientUploadId.
4. The server may use clientUploadId to prevent duplicate processing.

---

## Authentication

All endpoints require a valid JWT in the Authorization header:

Authorization: Bearer (token)

If the token is missing or invalid, the server returns 401.

---

## Error Handling Guidance

| Status Code | Meaning                         | Android Action                                                 |
| ----------- | ------------------------------- | -------------------------------------------------------------- |
| 400         | Bad request (validation failed) | Check request format; do not retry without fixing the issue    |
| 401         | Unauthorized                    | Prompt user to log in again                                    |
| 413         | File too large                  | Notify user; consider compressing audio or splitting recording |
| 429         | Rate limited                    | Wait for Retry-After duration, then retry                      |
| 500         | Server error                    | Retry with exponential backoff; if persistent, notify user     |
| 502/503     | MAIE unavailable                | Retry later; server may queue the request                      |

---

## Summary of Android Responsibilities

1. Generate a unique clientUploadId per recording session.
2. If live transcript is available, POST it to /api/files/text-pair-android with only the realtime field (no summary).
3. POST audio to /api/process with the audio file and optionally sourceTextFilePairId (from step 2) and clientUploadId.
4. Handle errors gracefully with retries for transient failures.
5. Never send a summary field; the server generates summaries via MAIE.

---

## Questions or Issues

If you encounter unexpected errors or need clarification on response formats, contact the backend team with:

- The endpoint called.
- The HTTP status code and response body.
- The clientUploadId (if applicable).
- Approximate timestamp.

---

Document version: 1.0  
Last updated: 2025
